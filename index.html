<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capy Fishing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Animations */
        @keyframes bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes splash {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(2deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }
        .bobbing {
            animation: bob 2s infinite ease-in-out;
        }
        .floating-capy {
            animation: float 3s infinite ease-in-out;
        }
        
        /* Disable selection for better game feel */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            background-color: #e0f2fe; /* light blue */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center text-slate-800 py-6 px-4">

    <!-- Main Container -->
    <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl border-4 border-slate-200 flex flex-col relative overflow-hidden">
        
        <!-- Header -->
        <div class="bg-teal-600 p-4 text-white flex justify-between items-center z-10 shadow-md">
            <div>
                <h1 class="font-bold text-xl">üçä Capy Fishing</h1>
                <p class="text-teal-100 text-xs">Catch 'em all!</p>
            </div>
            <div class="bg-teal-800 px-3 py-1 rounded-full flex items-center gap-2">
                <span>üí∞</span>
                <span id="money-display" class="font-mono font-bold">0</span>
            </div>
        </div>

        <!-- Game Area (The Pond) -->
        <div class="w-full h-[50vh] min-h-[400px] relative bg-blue-400 overflow-hidden no-select group cursor-pointer" id="pond-area" onclick="handlePondClick()">
            
            <!-- Sky/Horizon -->
            <div class="absolute top-0 w-full h-1/3 bg-gradient-to-b from-sky-300 to-blue-400">
                <div class="absolute top-4 left-4 opacity-50">‚òÅÔ∏è</div>
                <div class="absolute top-10 right-10 opacity-60">‚òÅÔ∏è</div>
            </div>

            <!-- Water Surface -->
            <div class="absolute bottom-0 w-full h-2/3 bg-blue-500 bg-opacity-90 backdrop-blur-sm">
                <!-- Reflections/Waves decorations -->
                <div class="absolute top-4 left-1/4 w-12 h-1 bg-white opacity-20 rounded-full"></div>
                <div class="absolute top-12 right-1/4 w-8 h-1 bg-white opacity-20 rounded-full"></div>
                <div class="absolute bottom-10 left-10 w-16 h-1 bg-white opacity-10 rounded-full"></div>
            </div>

            <!-- Player / Rod -->
            <div class="absolute bottom-16 right-4 z-20 transform transition-transform duration-300" id="fisherman">
                <div class="text-6xl">üé£</div>
            </div>

            <!-- The Bobber -->
            <div id="bobber" class="hidden absolute z-10 text-3xl transition-all duration-300 drop-shadow-md">
                
            </div>

            <!-- Messages -->
            <div id="game-message" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white font-bold text-2xl text-center drop-shadow-md z-30 pointer-events-none">
                Tap to Cast!
            </div>

            <!-- Visual Feedback for Catch -->
            <div id="catch-feedback" class="hidden absolute top-1/3 left-1/2 transform -translate-x-1/2 z-40 flex flex-col items-center animate-bounce">
                <!-- Changed from text-6xl to w-32 h-32 for SVG -->
                <div id="caught-emoji" class="w-32 h-32 mb-2 drop-shadow-xl"></div>
                <div id="caught-name" class="bg-white px-3 py-1 rounded-full shadow-lg font-bold text-sm text-slate-700"></div>
                <div id="caught-value" class="text-yellow-300 font-bold drop-shadow-md mt-1"></div>
            </div>

        </div>

        <!-- Controls & Info -->
        <div class="bg-slate-50 p-4 border-t border-slate-200 z-10">
            
            <!-- Bait Selector -->
            <div class="mb-4">
                <div class="flex justify-between items-end mb-1">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Current Bait</span>
                    <span id="bait-bonus" class="text-xs text-green-600 font-bold">Luck: Normal</span>
                </div>
                <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide" id="bait-container">
                    <!-- Baits generated by JS -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="openInventory()" class="bg-orange-100 hover:bg-orange-200 text-orange-800 py-3 rounded-xl font-bold transition-colors flex items-center justify-center gap-2">
                    üéí Bag (<span id="bag-count">0</span>)
                </button>
                <button onclick="sellAll()" class="bg-green-100 hover:bg-green-200 text-green-800 py-3 rounded-xl font-bold transition-colors flex items-center justify-center gap-2">
                    üíµ Sell All
                </button>
            </div>
        </div>

        <!-- Inventory Modal (Overlay) -->
        <div id="inventory-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center justify-center p-4">
            <div class="bg-white w-full max-w-md h-5/6 sm:h-3/4 rounded-3xl p-6 flex flex-col shadow-2xl animate-[slideUp_0.3s_ease-out]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-slate-800">Your Catch</h2>
                    <button onclick="closeInventory()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                
                <div id="inventory-list" class="flex-grow overflow-y-auto space-y-2 pr-2">
                    <!-- Items go here -->
                    <div class="text-center text-slate-400 mt-10 italic">Your bag is empty. Go fish!</div>
                </div>

                <div class="mt-4 pt-4 border-t border-slate-100">
                    <button onclick="sellAll(); closeInventory()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95">
                        Sell All for <span id="total-sell-value">$0</span>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Game Data & Config ---
        const gameState = {
            money: 0,
            inventory: [],
            currentBaitId: 'grass',
            isFishing: false,
            isWaitingForBite: false,
            isCasting: false, // Prevents accidental double-clicks when casting
            showingCatch: false, // Prevents spam-clicking the reward screen
            biteTimeout: null,
            reactionTimeout: null
        };

        const baits = {
            'grass': { id: 'grass', name: 'Dry Grass', cost: 0, luck: 1, icon: 'üåæ', desc: 'Free, but basic.' },
            'carrot': { id: 'carrot', name: 'Crunchy Carrot', cost: 50, luck: 1.5, icon: 'ü•ï', desc: 'Capys love the crunch.' },
            'melon': { id: 'melon', name: 'Watermelon', cost: 250, luck: 3, icon: 'üçâ', desc: 'The ultimate treat!' },
            'yuzu': { id: 'yuzu', name: 'Hot Yuzu', cost: 1000, luck: 6, icon: 'üçä', desc: 'For legendary relaxation.' }
        };

        // --- SVG Graphics Generator ---
        function createCapySVG(type) {
            // Base Capybara shape colors
            const bodyColor = "#BCAAA4"; // Light brown
            const strokeColor = "#795548"; // Darker brown
            const darkColor = "#3E2723"; // Dark brown features

            // Common base parts
            const base = `
                <g>
                    <!-- Ears -->
                    <circle cx="25" cy="30" r="9" fill="${bodyColor}" stroke="${strokeColor}" stroke-width="3"/>
                    <circle cx="75" cy="30" r="9" fill="${bodyColor}" stroke="${strokeColor}" stroke-width="3"/>
                    <!-- Head/Body -->
                    <rect x="15" y="25" width="70" height="55" rx="25" fill="${bodyColor}" stroke="${strokeColor}" stroke-width="3"/>
                    <!-- Eyes -->
                    <circle cx="35" cy="45" r="4" fill="${darkColor}"/>
                    <circle cx="65" cy="45" r="4" fill="${darkColor}"/>
                    <!-- Snout -->
                    <rect x="42" y="55" width="16" height="10" rx="4" fill="${darkColor}"/>
                    <path d="M50,55 V65" stroke="#5D4037" stroke-width="1"/>
                </g>
            `;
            
            let extras = '';
            
            if (type === 'muddy') {
                extras = `<path d="M15,60 Q25,45 35,60 Q45,35 55,55 Q65,45 75,65 V70 A25,25 0 0,1 15,70 V60 Z" fill="#5D4037" opacity="0.7"/>`;
            } else if (type === 'flower') {
                extras = `
                    <g transform="translate(20, 20)">
                        <circle cx="0" cy="0" r="12" fill="#F48FB1" stroke="#C2185B" stroke-width="2"/>
                        <circle cx="0" cy="0" r="5" fill="#FCE4EC"/>
                        <path d="M0,12 L0,18" stroke="#4CAF50" stroke-width="2"/>
                    </g>`;
            } else if (type === 'fancy') {
                extras = `
                    <g>
                        <rect x="30" y="5" width="40" height="25" fill="#212121" stroke="#000" stroke-width="2"/>
                        <rect x="20" y="30" width="60" height="5" fill="#212121" stroke="#000" stroke-width="2"/>
                        <rect x="30" y="23" width="40" height="4" fill="#E0E0E0"/>
                        <!-- Monocle -->
                        <circle cx="65" cy="45" r="9" stroke="#FFD700" stroke-width="2" fill="rgba(255, 255, 255, 0.3)"/>
                        <path d="M74,45 L74,60" stroke="#FFD700" stroke-width="2"/>
                    </g>`;
            } else if (type === 'king') {
                extras = `
                    <path d="M25,28 L25,5 L37,20 L50,0 L62,20 L75,5 L75,28 Z" fill="#FFD700" stroke="#FF8F00" stroke-width="2"/>
                    <circle cx="25" cy="5" r="3" fill="#D32F2F"/>
                    <circle cx="50" cy="0" r="3" fill="#D32F2F"/>
                    <circle cx="75" cy="5" r="3" fill="#D32F2F"/>
                `;
            } else if (type === 'ghost') {
                // Ghost replaces the base entirely
                return `<svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md overflow-visible">
                    <path d="M20,80 Q20,20 50,20 Q80,20 80,80 L70,75 L60,80 L50,75 L40,80 L30,75 L20,80 Z" fill="#E0F7FA" stroke="#B2EBF2" stroke-width="2" opacity="0.8"/>
                    <circle cx="35" cy="45" r="4" fill="#006064"/>
                    <circle cx="65" cy="45" r="4" fill="#006064"/>
                    <ellipse cx="50" cy="65" rx="6" ry="8" fill="#006064"/>
                </svg>`;
            }

            return `<svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md overflow-visible">${base}${extras}</svg>`;
        }

        const capyTypes = [
            { id: 'common', name: 'Common Capy', value: 5, rarity: 60, icon: createCapySVG('common'), minLuck: 1 },
            { id: 'muddy', name: 'Muddy Capy', value: 15, rarity: 25, icon: createCapySVG('muddy'), minLuck: 1 },
            { id: 'flower', name: 'Flower Capy', value: 45, rarity: 10, icon: createCapySVG('flower'), minLuck: 1.5 },
            { id: 'fancy', name: 'Fancy Capy', value: 120, rarity: 4, icon: createCapySVG('fancy'), minLuck: 1.5 },
            { id: 'king', name: 'King Capy', value: 350, rarity: 0.9, icon: createCapySVG('king'), minLuck: 3 },
            { id: 'ghost', name: 'Ghost Capy', value: 1000, rarity: 0.1, icon: createCapySVG('ghost'), minLuck: 6 }
        ];

        // --- Audio Context (Simple Synth for Sound Effects) ---
        // Using a simple oscillator to avoid external audio file dependencies
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === 'cast') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.3);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'bite') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'catch') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                osc.frequency.linearRampToValueAtTime(1200, now + 0.2);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.4);
            } else if (type === 'sell') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'fail') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        // --- Core Functions ---

        function init() {
            updateMoneyDisplay();
            renderBaits();
            updateBagCount();
        }

        function updateMoneyDisplay() {
            document.getElementById('money-display').textContent = gameState.money;
            renderBaits(); // Re-render baits to update affordable status
            updateSellButton();
        }

        function updateBagCount() {
            document.getElementById('bag-count').textContent = gameState.inventory.length;
        }

        function renderBaits() {
            const container = document.getElementById('bait-container');
            container.innerHTML = '';

            Object.values(baits).forEach(bait => {
                const isOwned = bait.id === 'grass'; // Only grass is owned by default (conceptually)
                const isCurrent = gameState.currentBaitId === bait.id;
                const canAfford = gameState.money >= bait.cost;
                
                // Logic: You "buy" bait for single use or unlock? 
                // Let's make it: You buy a pack. No, let's keep it simple: 
                // You pay to switch to it, if it costs money, it's a "License" or it's per cast?
                // Request said "buy better bait". Let's make it an Unlock system for simplicity in UI.
                // Or better: Consumable? No, let's do: Unlock upgrades.
                // Actually, let's just make it: Click to equip. If cost > 0, it deducts money ON EQUIP? 
                // Let's do: Unlock one time purchase.
                
                // Storing unlocks in gameState
                if (!gameState.unlockedBaits) gameState.unlockedBaits = ['grass'];

                const isUnlocked = gameState.unlockedBaits.includes(bait.id);

                const btn = document.createElement('div');
                btn.className = `
                    flex-shrink-0 w-32 p-2 rounded-xl border-2 cursor-pointer transition-all
                    ${isCurrent ? 'border-teal-500 bg-teal-50 ring-2 ring-teal-200' : 'border-slate-200 bg-white hover:border-teal-300'}
                    ${!isUnlocked && !canAfford ? 'opacity-60 grayscale' : ''}
                `;
                
                let actionText = '';
                if (isCurrent) actionText = 'Equipped';
                else if (isUnlocked) actionText = 'Equip';
                else actionText = `$${bait.cost}`;

                btn.innerHTML = `
                    <div class="text-2xl text-center mb-1">${bait.icon}</div>
                    <div class="font-bold text-sm text-center text-slate-700">${bait.name}</div>
                    <div class="text-xs text-center text-slate-500 mb-1">${bait.desc}</div>
                    <div class="text-xs font-bold text-center ${isCurrent ? 'text-teal-600' : (isUnlocked ? 'text-blue-500' : (canAfford ? 'text-green-600' : 'text-red-400'))}">
                        ${actionText}
                    </div>
                `;

                btn.onclick = (e) => {
                    e.stopPropagation();
                    if (isCurrent) return;
                    
                    if (isUnlocked) {
                        gameState.currentBaitId = bait.id;
                        renderBaits();
                    } else if (canAfford) {
                        gameState.money -= bait.cost;
                        gameState.unlockedBaits.push(bait.id);
                        gameState.currentBaitId = bait.id;
                        updateMoneyDisplay();
                        renderBaits();
                        playSound('sell'); // reuse coin sound
                    }
                };
                container.appendChild(btn);
            });

            // Update Luck Text
            const currentBait = baits[gameState.currentBaitId];
            let luckText = 'Normal';
            if (currentBait.luck > 1.5) luckText = 'High';
            if (currentBait.luck > 3) luckText = 'Legendary';
            document.getElementById('bait-bonus').textContent = `Luck: ${luckText}`;
        }

        // --- Fishing Logic ---

        function handlePondClick() {
            // Ignore clicks if casting animation or catch screen is active
            if (gameState.isCasting || gameState.showingCatch) return;

            const fisherman = document.getElementById('fisherman');
            const msg = document.getElementById('game-message');
            const bobber = document.getElementById('bobber');

            if (!gameState.isFishing) {
                // START FISHING
                gameState.isFishing = true;
                gameState.isCasting = true; // Lock input
                msg.textContent = "Waiting...";
                msg.classList.add('animate-pulse');
                
                // Show specific bait icon instead of generic bobber
                bobber.textContent = baits[gameState.currentBaitId].icon;

                // Animation: Cast
                fisherman.classList.add('-rotate-12');
                playSound('cast');
                
                setTimeout(() => {
                    fisherman.classList.remove('-rotate-12');
                    gameState.isCasting = false; // Unlock input
                    
                    // Show Bobber at random X
                    const randomX = 20 + Math.random() * 60;
                    const randomY = 30 + Math.random() * 40;
                    bobber.style.left = `${randomX}%`;
                    bobber.style.top = `${randomY}%`;
                    bobber.classList.remove('hidden');
                    bobber.classList.add('bobbing');
                    
                    // Wait for bite (2s to 5s)
                    const waitTime = 2000 + Math.random() * 3000;
                    
                    gameState.biteTimeout = setTimeout(() => {
                        triggerBite();
                    }, waitTime);

                }, 300);

            } else if (gameState.isWaitingForBite) {
                // CLICKED WHILE WAITING (Reel in)
                reelIn();
            } else {
                // CLICKED TOO EARLY (Before bite)
                // Just cancel cast
                cancelFishing("Too early!");
            }
        }

        function triggerBite() {
            if (!gameState.isFishing) return;

            gameState.isWaitingForBite = true;
            const msg = document.getElementById('game-message');
            const bobber = document.getElementById('bobber');
            
            msg.textContent = "‚ùó BITE! TAP NOW! ‚ùó";
            msg.classList.remove('animate-pulse');
            msg.classList.add('text-red-500', 'scale-110');
            
            bobber.classList.remove('bobbing');
            bobber.classList.add('animate-bounce'); // violent shaking
            playSound('bite');

            // Fail window (1s)
            gameState.reactionTimeout = setTimeout(() => {
                if (gameState.isFishing) {
                    cancelFishing("Got away...");
                }
            }, 1000); // 1 second window
        }

        function reelIn() {
            clearTimeout(gameState.reactionTimeout);
            
            if (gameState.isWaitingForBite) {
                gameState.isWaitingForBite = false; // Prevent spam by clearing state immediately
                // SUCCESS
                determineCatch();
            } else {
                // Should catch stray clicks
                cancelFishing("???");
            }
        }

        function determineCatch() {
            const bait = baits[gameState.currentBaitId];
            const luck = bait.luck;
            
            // Filter capys by minLuck required by bait (some rares need better bait)
            
            let pool = [];
            capyTypes.forEach(capy => {
                if (luck >= capy.minLuck) {
                    // Modified Logic:
                    // Better bait significantly decreases the rate of "worse" capybaras.
                    
                    let weight;
                    // Common (5) and Muddy (15) are considered "worse"
                    if (capy.value <= 15) {
                        // Divides their rarity by luck.
                        // Example: Yuzu (Luck 6) makes Common capys 6x less likely than base.
                        weight = capy.rarity / luck; 
                    } else {
                        // Multiplies good capys by luck.
                        weight = capy.rarity * luck;
                    }

                    pool.push({ ...capy, weight: weight });
                }
            });

            // Weighted Random
            const totalWeight = pool.reduce((sum, item) => sum + item.weight, 0);
            let random = Math.random() * totalWeight;
            let caught = pool[0]; // fallback

            for (let item of pool) {
                if (random < item.weight) {
                    caught = item;
                    break;
                }
                random -= item.weight;
            }

            showCatch(caught);
        }

        function showCatch(capy) {
            gameState.inventory.push(capy);
            gameState.showingCatch = true; // Lock input during celebration
            updateBagCount();
            playSound('catch');
            
            // Visuals
            const feedback = document.getElementById('catch-feedback');
            const img = document.getElementById('caught-emoji');
            const name = document.getElementById('caught-name');
            const val = document.getElementById('caught-value');
            
            // Changed from textContent to innerHTML for SVG support
            img.innerHTML = capy.icon;
            name.textContent = capy.name;
            val.textContent = `+$${capy.value}`;
            
            feedback.classList.remove('hidden');
            document.getElementById('bobber').classList.add('hidden');
            document.getElementById('game-message').textContent = "Gotcha!";

            // Reset after delay
            setTimeout(() => {
                feedback.classList.add('hidden');
                gameState.showingCatch = false;
                resetFishingState();
            }, 2000);
        }

        function cancelFishing(reason) {
            const msg = document.getElementById('game-message');
            msg.textContent = reason;
            msg.classList.remove('text-red-500', 'scale-110');
            playSound('fail');
            
            document.getElementById('bobber').classList.add('hidden');
            
            setTimeout(() => {
                resetFishingState();
            }, 1000);
        }

        function resetFishingState() {
            gameState.isFishing = false;
            gameState.isWaitingForBite = false;
            clearTimeout(gameState.biteTimeout);
            clearTimeout(gameState.reactionTimeout);
            
            const msg = document.getElementById('game-message');
            msg.textContent = "Tap to Cast!";
            msg.classList.remove('animate-pulse', 'text-red-500', 'scale-110');
            
            const bobber = document.getElementById('bobber');
            bobber.classList.add('hidden');
            bobber.classList.remove('bobbing', 'animate-bounce');
        }

        // --- Shop & Inventory Logic ---

        function openInventory() {
            const modal = document.getElementById('inventory-modal');
            const list = document.getElementById('inventory-list');
            const totalValSpan = document.getElementById('total-sell-value');
            
            modal.classList.remove('hidden');
            list.innerHTML = '';

            if (gameState.inventory.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-400 mt-10 italic">Your bag is empty. Go fish!</div>';
            } else {
                // Group items? No, simple list is more satisfying for "Sell All" effect
                gameState.inventory.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between bg-slate-50 p-2 rounded-lg border border-slate-100';
                    // Changed span text-2xl to div w-12 h-12 for SVG support
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12">${item.icon}</div>
                            <span class="font-bold text-slate-700">${item.name}</span>
                        </div>
                        <span class="font-mono text-green-600 font-bold">$${item.value}</span>
                    `;
                    list.appendChild(el);
                });
            }

            const totalValue = gameState.inventory.reduce((sum, item) => sum + item.value, 0);
            totalValSpan.textContent = `$${totalValue}`;
            
            // Only calc sell button update here to avoid recalcing on every render
            updateSellButton(totalValue);
        }

        function closeInventory() {
            document.getElementById('inventory-modal').classList.add('hidden');
        }

        function sellAll() {
            if (gameState.inventory.length === 0) return;

            const totalValue = gameState.inventory.reduce((sum, item) => sum + item.value, 0);
            gameState.money += totalValue;
            gameState.inventory = []; // clear array
            
            playSound('sell');
            updateMoneyDisplay();
            updateBagCount();
            
            // Visual feedback
            const msg = document.getElementById('game-message');
            const oldMsg = msg.textContent;
            msg.textContent = `Sold for $${totalValue}!`;
            setTimeout(() => {
                if (!gameState.isFishing) msg.textContent = "Tap to Cast!";
            }, 2000);
        }

        function updateSellButton(val) {
            // Helper to update text in modal if passed, otherwise just general logic
             const currentVal = val !== undefined ? val : gameState.inventory.reduce((sum, item) => sum + item.value, 0);
             document.getElementById('total-sell-value').textContent = `$${currentVal}`;
        }

        // Start
        init();

    </script>
</body>
</html>