<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capy Fishing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Animations */
        @keyframes bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes splash {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(2deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }
        @keyframes party {
            0%, 100% { transform: rotate(-5deg) scale(1); }
            50% { transform: rotate(5deg) scale(1.1); }
        }
        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }
        .bobbing {
            animation: bob 2s infinite ease-in-out;
        }
        .party-time {
            animation: party 1s infinite ease-in-out;
        }
        .glitch-effect {
            animation: glitch 0.2s infinite;
        }
        
        /* Disable selection for better game feel */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            background-color: #e0f2fe; /* light blue */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center text-slate-800 py-6 px-4">

    <!-- Main Container -->
    <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl border-4 border-slate-200 flex flex-col relative overflow-hidden">
        
        <!-- Header -->
        <div class="bg-teal-600 p-4 text-white flex justify-between items-center z-10 shadow-md relative">
            <div>
                <h1 class="font-bold text-xl">üçä Capy Fishing</h1>
                <p class="text-teal-100 text-xs">Catch 'em all!</p>
            </div>
            
            <!-- Birthday Capy Slot (Hidden until unlocked) -->
            <div id="birthday-slot" class="hidden absolute left-1/2 transform -translate-x-1/2 top-2 flex flex-col items-center group cursor-pointer" title="Happy Birthday Griffin!">
                <div class="w-10 h-10 party-time" id="birthday-icon"></div>
                <span class="text-[10px] font-bold text-yellow-300 animate-pulse">+$10/s</span>
            </div>

            <div class="flex items-center gap-2">
                 <!-- Auto Fish Toggle (Hidden until bought) -->
                 <button onclick="toggleAutoFish()" id="autofish-btn" class="hidden text-xl bg-slate-700 w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-600 transition-colors shadow-inner border-2 border-transparent" title="Toggle Auto-Fish">
                    ü§ñ
                </button>

                 <button onclick="toggleMusic()" id="music-btn" class="text-xl bg-teal-700 w-10 h-10 flex items-center justify-center rounded-full hover:bg-teal-500 transition-colors shadow-inner" title="Toggle Music">
                    üîá
                </button>
                <div class="bg-teal-800 px-3 py-1 rounded-full flex items-center gap-2">
                    <span>üí∞</span>
                    <span id="money-display" class="font-mono font-bold">0</span>
                </div>
            </div>
        </div>

        <!-- Game Area (The Pond) -->
        <div class="w-full h-[50vh] min-h-[400px] relative bg-blue-400 overflow-hidden no-select group cursor-pointer" id="pond-area" onclick="handlePondClick()">
            
            <!-- Sky/Horizon -->
            <div class="absolute top-0 w-full h-1/3 bg-gradient-to-b from-sky-300 to-blue-400">
                <div class="absolute top-4 left-4 opacity-50">‚òÅÔ∏è</div>
                <div class="absolute top-10 right-10 opacity-60">‚òÅÔ∏è</div>
            </div>

            <!-- Water Surface -->
            <div class="absolute bottom-0 w-full h-2/3 bg-blue-500 bg-opacity-90 backdrop-blur-sm">
                <!-- Reflections/Waves decorations -->
                <div class="absolute top-4 left-1/4 w-12 h-1 bg-white opacity-20 rounded-full"></div>
                <div class="absolute top-12 right-1/4 w-8 h-1 bg-white opacity-20 rounded-full"></div>
                <div class="absolute bottom-10 left-10 w-16 h-1 bg-white opacity-10 rounded-full"></div>
            </div>

            <!-- Player / Rod -->
            <div class="absolute bottom-16 right-4 z-20 transform transition-transform duration-300" id="fisherman">
                <div class="text-6xl">üé£</div>
            </div>

            <!-- Messages -->
            <div id="game-message" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white font-bold text-2xl text-center drop-shadow-md z-30 pointer-events-none w-full">
                Tap to Cast!
            </div>

            <!-- Visual Feedback for Catch -->
            <div id="catch-feedback" class="hidden absolute top-1/3 left-1/2 transform -translate-x-1/2 z-40 flex flex-col items-center animate-bounce">
                <!-- Catch SVG container -->
                <div id="caught-emoji" class="w-32 h-32 mb-2 drop-shadow-xl flex items-center justify-center"></div>
                <div id="caught-name" class="bg-white px-3 py-1 rounded-full shadow-lg font-bold text-sm text-slate-700 whitespace-nowrap"></div>
                <div id="caught-value" class="text-yellow-300 font-bold drop-shadow-md mt-1"></div>
                <div id="new-discovery" class="hidden mt-2 text-xs font-bold text-white bg-orange-500 px-2 py-1 rounded-full animate-pulse">NEW!</div>
            </div>

        </div>

        <!-- Controls & Info -->
        <div class="bg-slate-50 p-4 border-t border-slate-200 z-10">
            
            <!-- Bait Selector -->
            <div class="mb-4">
                <div class="flex justify-between items-end mb-1">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Current Bait</span>
                    <span id="bait-bonus" class="text-xs text-green-600 font-bold">Luck: Normal</span>
                </div>
                <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide" id="bait-container">
                    <!-- Baits generated by JS -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-4 gap-2">
                <button onclick="openInventory()" class="bg-orange-100 hover:bg-orange-200 text-orange-800 py-3 rounded-xl font-bold transition-colors flex flex-col items-center justify-center text-xs sm:text-sm">
                    <span class="text-xl mb-1">üéí</span>
                    Bag <span id="bag-count">0</span>
                </button>
                <button onclick="openIndex()" class="bg-blue-100 hover:bg-blue-200 text-blue-800 py-3 rounded-xl font-bold transition-colors flex flex-col items-center justify-center text-xs sm:text-sm">
                    <span class="text-xl mb-1">üìñ</span>
                    <div class="flex items-center gap-1">
                        Index <span id="index-progress" class="text-[10px] bg-blue-300/30 px-1.5 rounded-full">0/30</span>
                    </div>
                </button>
                 <button onclick="openUpgrades()" class="bg-purple-100 hover:bg-purple-200 text-purple-800 py-3 rounded-xl font-bold transition-colors flex flex-col items-center justify-center text-xs sm:text-sm">
                    <span class="text-xl mb-1">‚ö°</span>
                    Upgrades
                </button>
                <button onclick="openAdmin()" class="bg-red-100 hover:bg-red-200 text-red-800 py-3 rounded-xl font-bold transition-colors flex flex-col items-center justify-center text-xs sm:text-sm">
                    <span class="text-xl mb-1">‚öôÔ∏è</span>
                    Admin
                </button>
            </div>
        </div>

        <!-- Inventory Modal (Overlay) -->
        <div id="inventory-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center justify-center p-4">
            <div class="bg-white w-full max-w-md h-5/6 sm:h-3/4 rounded-3xl p-6 flex flex-col shadow-2xl animate-[slideUp_0.3s_ease-out]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-slate-800">Your Catch</h2>
                    <button onclick="closeInventory()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                
                <div id="inventory-list" class="flex-grow overflow-y-auto space-y-2 pr-2">
                    <!-- Items go here -->
                </div>

                <div class="mt-4 pt-4 border-t border-slate-100">
                    <button onclick="sellAll(); closeInventory()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95">
                        Sell All for <span id="total-sell-value">$0</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Index Modal (Overlay) -->
        <div id="index-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center justify-center p-4">
            <div class="bg-white w-full max-w-md h-5/6 sm:h-3/4 rounded-3xl p-6 flex flex-col shadow-2xl animate-[slideUp_0.3s_ease-out]">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Capy Index</h2>
                        <p class="text-xs text-slate-500">Collect all for a Birthday Surprise!</p>
                    </div>
                    <button onclick="closeIndex()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                
                <div id="index-grid" class="flex-grow overflow-y-auto grid grid-cols-3 gap-3 pr-2 content-start">
                    <!-- Index Items go here -->
                </div>
            </div>
        </div>

        <!-- Upgrades Modal (Overlay) -->
        <div id="upgrades-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center justify-center p-4">
            <div class="bg-white w-full max-w-md h-auto max-h-[90%] rounded-3xl p-6 flex flex-col shadow-2xl animate-[slideUp_0.3s_ease-out]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-slate-800">Upgrades</h2>
                    <button onclick="closeUpgrades()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                
                <div id="upgrades-list" class="flex-grow overflow-y-auto space-y-3 pr-2">
                    <!-- Upgrades go here -->
                </div>
            </div>
        </div>

        <!-- Admin Modal (Overlay) -->
        <div id="admin-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center justify-center p-4">
            <div class="bg-white w-full max-w-md h-auto rounded-3xl p-6 flex flex-col shadow-2xl animate-[slideUp_0.3s_ease-out]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-slate-800">Admin Panel</h2>
                    <button onclick="closeAdmin()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="adminAddMoney(5000)" class="bg-green-100 text-green-800 py-3 rounded-xl font-bold hover:bg-green-200">+$5,000</button>
                    <button onclick="adminAddMoney(50000)" class="bg-green-100 text-green-800 py-3 rounded-xl font-bold hover:bg-green-200">+$50,000</button>
                    <button onclick="adminUnlockAll()" class="col-span-2 bg-blue-100 text-blue-800 py-3 rounded-xl font-bold hover:bg-blue-200">Unlock All Capys</button>
                    <button onclick="resetGame()" class="col-span-2 bg-red-100 text-red-800 py-3 rounded-xl font-bold hover:bg-red-200">Reset Save</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Game Data & Config ---
        const gameState = {
            money: 0,
            inventory: [],
            discovered: new Set(),
            birthdayUnlocked: false,
            currentBaitId: 'grass',
            
            // Consumable Bait State
            baitStock: { grass: Infinity, carrot: 0, melon: 0, apple: 0, yuzu: 0, sushi: 0, truffle: 0 },

            isFishing: false,
            isWaitingForBite: false,
            isCasting: false, 
            isOnCooldown: false, 
            showingCatch: false, 
            biteTimeout: null,
            reactionTimeout: null,
            musicPlaying: false,
            musicInterval: null,
            passiveIncomeInterval: null,
            
            // Upgrade States
            sellMultiplierLevel: 0,
            lureLevel: 0,
            hasAutoFish: false,
            isAutoFishing: false,
            autoFishTimeout: null,

            // Griffin Mode
            tripleCatchMode: false
        };

        const upgradeData = {
            sell: { name: "Market Connections", max: 5, costs: [100, 250, 500, 1000, 2000], desc: "+20% Sell Value" },
            lure: { name: "Shiny Lure", max: 5, costs: [50, 150, 300, 600, 1200], desc: "Fish bite 15% faster" },
            auto: { name: "Auto-Fisher 3000", max: 1, costs: [250], desc: "Unlocks Auto-Fish (1.5x duration)" }
        };

        const baits = {
            'grass': { id: 'grass', name: 'Dry Grass', cost: 0, luck: 1, icon: 'üåæ', desc: 'Free, but basic.' },
            'carrot': { id: 'carrot', name: 'Crunchy Carrot', cost: 15, luck: 1.5, icon: 'ü•ï', desc: 'Capys love the crunch.' },
            'melon': { id: 'melon', name: 'Watermelon', cost: 50, luck: 3, icon: 'üçâ', desc: 'The ultimate treat!' },
            'apple': { id: 'apple', name: 'Golden Apple', cost: 350, luck: 4.5, icon: 'üçé', desc: 'Shiny and delicious.' },
            'yuzu': { id: 'yuzu', name: 'Hot Yuzu', cost: 500, luck: 6, icon: 'üçä', desc: 'For legendary relaxation.' },
            'sushi': { id: 'sushi', name: 'Veggie Sushi', cost: 1000, luck: 9, icon: 'üç£', desc: 'A sophisticated snack.' },
            'truffle': { id: 'truffle', name: 'Diamond Truffle', cost: 2000, luck: 15, icon: 'üíé', desc: 'Pure luxury.' }
        };

        // --- SVG Graphics Generator ---
        function createCapySVG(type) {
            // Colors
            const bodyColor = "#BA8E63"; // Warm brown
            const strokeColor = "#543D32"; 
            const darkColor = "#2A1D18"; 
            const highlight = "#D4B491"; 

            // Base Art
            const base = `
                <g>
                    <!-- Ears -->
                    <path d="M18,35 Q12,23 28,25" fill="${bodyColor}" stroke="${strokeColor}" stroke-width="3" stroke-linecap="round" />
                    <path d="M82,35 Q88,23 72,25" fill="${bodyColor}" stroke="${strokeColor}" stroke-width="3" stroke-linecap="round" />
                    <!-- Head/Body -->
                    <rect x="15" y="25" width="70" height="55" rx="18" fill="${bodyColor}" stroke="${strokeColor}" stroke-width="3"/>
                    <!-- Snout -->
                    <rect x="38" y="55" width="24" height="15" rx="6" fill="${highlight}" opacity="0.4"/>
                    <!-- Eyes -->
                    <circle cx="35" cy="45" r="4.5" fill="${darkColor}"/>
                    <circle cx="65" cy="45" r="4.5" fill="${darkColor}"/>
                    <circle cx="37" cy="43" r="1.5" fill="white" opacity="0.8"/>
                    <circle cx="67" cy="43" r="1.5" fill="white" opacity="0.8"/>
                    <!-- Nose -->
                    <path d="M45,60 L49,60 M51,60 L55,60" stroke="${darkColor}" stroke-width="2.5" stroke-linecap="round"/>
                    <!-- Mouth -->
                    <path d="M50,64 L50,68 M45,68 Q50,73 55,68" stroke="${darkColor}" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                </g>
            `;
            
            let extras = '';
            
            switch (type) {
                case 'muddy': extras = `<path d="M15,65 Q25,50 35,65 Q45,45 55,60 Q65,50 75,70 V80 A18,18 0 0,1 15,80 V65 Z" fill="#5D4037" opacity="0.8"/>`; break;
                case 'flower': extras = `<g transform="translate(20, 20)"><circle cx="0" cy="0" r="12" fill="#F48FB1" stroke="#C2185B" stroke-width="2"/><circle cx="0" cy="0" r="5" fill="#FCE4EC"/><path d="M0,12 L0,18" stroke="#4CAF50" stroke-width="2"/></g>`; break;
                case 'chef': extras = `<g transform="translate(0, -15)"><path d="M30,25 L30,5 Q50,-10 70,5 L70,25" fill="#FFFFFF" stroke="#E0E0E0" stroke-width="2"/><rect x="25" y="25" width="50" height="10" fill="#FFFFFF" stroke="#E0E0E0" stroke-width="2"/><path d="M25,80 L75,80 L70,95 L30,95 Z" fill="#D32F2F" /></g>`; break;
                case 'dino': extras = `<path d="M15,25 Q10,10 50,5 Q90,10 85,25" fill="none" stroke="#66BB6A" stroke-width="8"/><path d="M50,5 L40,15 M50,5 L60,15" stroke="#66BB6A" stroke-width="4"/>`; break;
                case 'fancy': extras = `<g><rect x="30" y="5" width="40" height="25" fill="#212121" stroke="#000" stroke-width="2"/><rect x="20" y="30" width="60" height="5" fill="#212121" stroke="#000" stroke-width="2"/><rect x="30" y="23" width="40" height="4" fill="#E0E0E0"/><circle cx="65" cy="45" r="9" stroke="#FFD700" stroke-width="2" fill="rgba(255, 255, 255, 0.3)"/><path d="M74,45 L74,60" stroke="#FFD700" stroke-width="2"/></g>`; break;
                case 'pirate': extras = `<path d="M20,25 Q50,15 80,25 L85,20 L15,20 Z" fill="#212121"/><circle cx="60" cy="20" r="5" fill="#FFFFFF" opacity="0.3"/><path d="M30,45 L40,45 L40,45" stroke="#000" stroke-width="3"/><circle cx="35" cy="45" r="6" fill="#000"/>`; break;
                case 'ninja': extras = `<rect x="15" y="32" width="70" height="15" fill="#212121"/><circle cx="35" cy="39" r="2" fill="#FFFFFF"/><circle cx="65" cy="39" r="2" fill="#FFFFFF"/><path d="M85,32 L95,22 L95,42 Z" fill="#212121"/>`; break;
                case 'wizard': extras = `<path d="M20,25 L50,-10 L80,25 Z" fill="#673AB7"/><circle cx="50" cy="10" r="3" fill="#FFD700"/><path d="M15,25 Q50,20 85,25" stroke="#673AB7" stroke-width="4" fill="none"/>`; break;
                case 'robot': extras = `<rect x="35" y="40" width="10" height="10" fill="#EF5350" opacity="0.8"/><circle cx="65" cy="45" r="4" fill="#42A5F5"/><line x1="15" y1="25" x2="85" y2="25" stroke="#B0BEC5" stroke-width="2"/><path d="M50,25 L50,10" stroke="#90A4AE" stroke-width="2"/><circle cx="50" cy="10" r="3" fill="#FF5252" class="animate-pulse"/>`; break;
                case 'king': extras = `<path d="M25,28 L25,5 L37,20 L50,0 L62,20 L75,5 L75,28 Z" fill="#FFD700" stroke="#FF8F00" stroke-width="2"/><circle cx="25" cy="5" r="3" fill="#D32F2F"/><circle cx="50" cy="0" r="3" fill="#D32F2F"/><circle cx="75" cy="5" r="3" fill="#D32F2F"/>`; break;
                case 'space': extras = `<circle cx="50" cy="50" r="40" fill="rgba(179, 229, 252, 0.4)" stroke="#81D4FA" stroke-width="2"/><rect x="40" y="80" width="20" height="10" fill="#9E9E9E"/>`; break;
                case 'ghost': return `<svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md overflow-visible"><path d="M20,80 Q20,20 50,20 Q80,20 80,80 L70,75 L60,80 L50,75 L40,80 L30,75 L20,80 Z" fill="#E0F7FA" stroke="#B2EBF2" stroke-width="2" opacity="0.8"/><circle cx="35" cy="45" r="4.5" fill="#006064"/><circle cx="65" cy="45" r="4.5" fill="#006064"/><path d="M45,60 L55,60" stroke="#006064" stroke-width="2"/><circle cx="37" cy="43" r="1.5" fill="white" opacity="0.5"/></svg>`;
                case 'rainbow': return `<svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md overflow-visible"><defs><linearGradient id="rainbowGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:red;stop-opacity:1" /><stop offset="20%" style="stop-color:orange;stop-opacity:1" /><stop offset="40%" style="stop-color:yellow;stop-opacity:1" /><stop offset="60%" style="stop-color:green;stop-opacity:1" /><stop offset="80%" style="stop-color:blue;stop-opacity:1" /><stop offset="100%" style="stop-color:violet;stop-opacity:1" /></linearGradient></defs>${base.replace(`fill="${bodyColor}"`, `fill="url(#rainbowGrad)"`).replace(`fill="${highlight}"`, `fill="white"`)}</svg>`;
                case 'birthday': extras = `<path d="M30,25 L50,-10 L70,25 Z" fill="#FFEB3B" stroke="#FBC02D" stroke-width="1"/><circle cx="50" cy="-10" r="3" fill="#FF5252"/><circle cx="40" cy="15" r="2" fill="#42A5F5"/><circle cx="60" cy="10" r="2" fill="#66BB6A"/><path d="M20,80 Q50,90 80,80" fill="none" stroke="#EC407A" stroke-width="3"/>`; break;
                
                // NEW CAPYS
                case 'vampire': extras = `<path d="M30,20 L30,35 L70,35 L70,20 Q50,10 30,20" fill="none" stroke="black" stroke-width="2"/><rect x="35" y="65" width="5" height="8" fill="white"/><rect x="60" y="65" width="5" height="8" fill="white"/>`; break;
                case 'zombie': return `<svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md overflow-visible">${base.replace(bodyColor, "#81C784").replace(darkColor, "#1B5E20")}<path d="M30,30 L40,40" stroke="black"/><path d="M25,60 L35,65" stroke="black"/></svg>`;
                case 'super': extras = `<path d="M10,40 L90,40 L80,90 L20,90 Z" fill="#D32F2F" opacity="0.8"/><circle cx="50" cy="50" r="15" fill="#1976D2"/><path d="M45,45 L55,45 L50,60 Z" fill="#FFD700"/>`; break;
                case 'angel': extras = `<circle cx="50" cy="15" r="15" fill="none" stroke="#FFD700" stroke-width="3"/><path d="M10,40 Q-10,20 10,10 L20,30" fill="white" stroke="#E0E0E0"/><path d="M90,40 Q110,20 90,10 L80,30" fill="white" stroke="#E0E0E0"/>`; break;
                case 'demon': extras = `<path d="M25,28 L15,10 L30,20 Z" fill="#D32F2F"/><path d="M75,28 L85,10 L70,20 Z" fill="#D32F2F"/><path d="M45,70 L50,75 L55,70" fill="none" stroke="black"/>`; break;
                case 'frozen': return `<svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md overflow-visible">${base.replace(bodyColor, "#81D4FA").replace(highlight, "#B3E5FC")}<path d="M30,30 L35,35 M35,30 L30,35" stroke="white" stroke-width="2"/></svg>`;
                case 'magma': return `<svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md overflow-visible">${base.replace(bodyColor, "#3E2723")}<path d="M20,40 Q50,20 80,40" fill="none" stroke="#FF5722" stroke-width="3"/><circle cx="30" cy="70" r="2" fill="#FFC107"/><circle cx="70" cy="60" r="3" fill="#FFC107"/></svg>`;
                case 'cactus': return `<svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md overflow-visible">${base.replace(bodyColor, "#66BB6A")}<path d="M20,40 L15,35" stroke="green" stroke-width="2"/><path d="M80,50 L85,45" stroke="green" stroke-width="2"/></svg>`;
                case 'bee': extras = `<path d="M20,40 L80,40" stroke="#212121" stroke-width="4"/><path d="M20,60 L80,60" stroke="#212121" stroke-width="4"/><path d="M10,30 Q0,10 20,20" fill="white" opacity="0.7"/><path d="M90,30 Q100,10 80,20" fill="white" opacity="0.7"/>`; break;
                case 'doctor': extras = `<circle cx="50" cy="20" r="10" fill="white" stroke="#E0E0E0"/><path d="M45,20 L55,20 M50,15 L50,25" stroke="red" stroke-width="3"/>`; break;
                case 'builder': extras = `<path d="M20,30 L80,30 L75,10 L25,10 Z" fill="#FFC107"/><rect x="25" y="10" width="50" height="5" fill="#FFB300"/>`; break;
                case 'detective': extras = `<path d="M20,25 Q50,10 80,25" fill="#795548"/><rect x="20" y="25" width="60" height="5" fill="#5D4037"/><circle cx="75" cy="55" r="8" fill="none" stroke="black" stroke-width="2"/><line x1="81" y1="61" x2="90" y2="70" stroke="black" stroke-width="2"/>`; break;
                case 'gamer': extras = `<rect x="25" y="30" width="50" height="20" fill="#212121"/><rect x="30" y="35" width="40" height="10" fill="#00E676" opacity="0.5"/><path d="M20,25 L20,45" stroke="black" stroke-width="3"/><path d="M80,25 L80,45" stroke="black" stroke-width="3"/>`; break;
                case 'glitch': return `<svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md overflow-visible glitch-effect">${base.replace(bodyColor, "#00E5FF").replace(strokeColor, "#FF00E6")}</svg>`;
                case 'golden': return `<svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md overflow-visible"><defs><radialGradient id="goldGrad"><stop offset="0%" stop-color="#FFF9C4"/><stop offset="100%" stop-color="#FBC02D"/></radialGradient></defs>${base.replace(bodyColor, "url(#goldGrad)").replace(strokeColor, "#F57F17")}<circle cx="20" cy="20" r="5" fill="white" opacity="0.6" class="animate-pulse"/></svg>`;
                case 'skeleton': return `<svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md overflow-visible"><rect x="30" y="30" width="40" height="40" fill="#ECEFF1" stroke="#455A64" stroke-width="2" rx="5"/><circle cx="40" cy="45" r="5" fill="#263238"/><circle cx="60" cy="45" r="5" fill="#263238"/><rect x="45" y="55" width="10" height="8" fill="#263238" rx="2"/></svg>`;
            }

            return `<svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-md overflow-visible">${base}${extras}</svg>`;
        }

        const capyTypes = [
            { id: 'common', name: 'Common', value: 5, rarity: 100, minLuck: 1 },
            { id: 'muddy', name: 'Muddy', value: 15, rarity: 60, minLuck: 1 },
            { id: 'flower', name: 'Flower', value: 35, rarity: 30, minLuck: 1.2 },
            { id: 'chef', name: 'Chef', value: 45, rarity: 25, minLuck: 1.5 },
            { id: 'builder', name: 'Builder', value: 50, rarity: 22, minLuck: 1.5 },
            { id: 'doctor', name: 'Doctor', value: 55, rarity: 21, minLuck: 1.5 },
            { id: 'dino', name: 'Dino', value: 60, rarity: 20, minLuck: 1.5 },
            { id: 'detective', name: 'Detective', value: 75, rarity: 18, minLuck: 1.5 },
            { id: 'gamer', name: 'Gamer', value: 80, rarity: 17, minLuck: 1.5 },
            { id: 'fancy', name: 'Fancy', value: 100, rarity: 15, minLuck: 1.5 },
            { id: 'pirate', name: 'Pirate', value: 120, rarity: 12, minLuck: 2.0 },
            { id: 'bee', name: 'Bee', value: 130, rarity: 11, minLuck: 2.0 },
            { id: 'cactus', name: 'Cactus', value: 140, rarity: 11, minLuck: 2.0 },
            { id: 'ninja', name: 'Ninja', value: 150, rarity: 10, minLuck: 2.0 },
            { id: 'wizard', name: 'Wizard', value: 200, rarity: 8, minLuck: 3.0 },
            { id: 'vampire', name: 'Vampire', value: 220, rarity: 7, minLuck: 3.0 },
            { id: 'zombie', name: 'Zombie', value: 230, rarity: 7, minLuck: 3.0 },
            { id: 'robot', name: 'Robot', value: 250, rarity: 6, minLuck: 3.0 },
            { id: 'frozen', name: 'Frozen', value: 300, rarity: 5, minLuck: 3.5 },
            { id: 'magma', name: 'Magma', value: 300, rarity: 5, minLuck: 3.5 },
            { id: 'skeleton', name: 'Skeleton', value: 333, rarity: 4.5, minLuck: 3.5 },
            { id: 'angel', name: 'Angel', value: 400, rarity: 4, minLuck: 4.0 },
            { id: 'demon', name: 'Demon', value: 400, rarity: 4, minLuck: 4.0 },
            { id: 'king', name: 'King', value: 500, rarity: 3, minLuck: 4.0 },
            { id: 'super', name: 'Super', value: 600, rarity: 2.5, minLuck: 4.5 },
            { id: 'glitch', name: 'Glitch', value: 777, rarity: 2.2, minLuck: 5.0 },
            { id: 'space', name: 'Space', value: 800, rarity: 2, minLuck: 5.0 },
            { id: 'golden', name: 'Golden', value: 1000, rarity: 1.5, minLuck: 5.5 },
            { id: 'ghost', name: 'Ghost', value: 1500, rarity: 1, minLuck: 6.0 },
            { id: 'rainbow', name: 'Rainbow', value: 5000, rarity: 0.1, minLuck: 6.0 }
        ];

        // Add icons to objects
        capyTypes.forEach(c => c.icon = createCapySVG(c.id));

        // --- Audio Context (Simple Synth) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        // Music Logic
        function toggleMusic() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const btn = document.getElementById('music-btn');
            
            if (gameState.musicPlaying) {
                gameState.musicPlaying = false;
                clearInterval(gameState.musicInterval);
                btn.textContent = "üîá";
            } else {
                gameState.musicPlaying = true;
                btn.textContent = "üéµ";
                playAmbientMusic();
            }
        }

        function playAmbientMusic() {
            const notes = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25];
            
            const playNote = () => {
                if (!gameState.musicPlaying) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                const freq = notes[Math.floor(Math.random() * notes.length)];
                osc.frequency.value = freq;
                osc.type = 'sine';
                const now = audioCtx.currentTime;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.05, now + 1);
                gain.gain.linearRampToValueAtTime(0, now + 4);
                osc.start(now);
                osc.stop(now + 4);
            };
            playNote();
            gameState.musicInterval = setInterval(playNote, 2500);
        }

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'cast') {
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.3);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'bite') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'catch') {
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                osc.frequency.linearRampToValueAtTime(1200, now + 0.2);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.4);
            } else if (type === 'sell') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'fail') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        // --- Core Functions ---

        function init() {
            updateMoneyDisplay();
            renderBaits();
            updateBagCount();
            startPassiveIncome();
            
            // Render Birthday Capy Icon in header
            document.getElementById('birthday-icon').innerHTML = createCapySVG('birthday');
        }

        function startPassiveIncome() {
            if (gameState.passiveIncomeInterval) clearInterval(gameState.passiveIncomeInterval);
            
            gameState.passiveIncomeInterval = setInterval(() => {
                if (gameState.birthdayUnlocked) {
                    gameState.money += 10;
                    updateMoneyDisplay();
                    const display = document.getElementById('money-display');
                    display.classList.add('text-green-500');
                    setTimeout(() => display.classList.remove('text-green-500'), 200);
                }
            }, 1000);
        }

        function updateMoneyDisplay() {
            document.getElementById('money-display').textContent = Math.floor(gameState.money);
            renderBaits(); // Re-render baits to update affordable status
            updateSellButton();
            renderUpgrades(); // Update upgrade buttons
        }

        function updateBagCount() {
            document.getElementById('bag-count').textContent = gameState.inventory.length;
        }

        function checkIndexCompletion() {
            if (gameState.birthdayUnlocked) return;
            
            if (gameState.discovered.size === capyTypes.length) {
                gameState.birthdayUnlocked = true;
                gameState.tripleCatchMode = true; // Unlock Triple Catch
                
                // Reveal the slot
                document.getElementById('birthday-slot').classList.remove('hidden');
                alert("üéÇ Happy Birthday Griffin! üéÇ\n\nYou've unlocked:\n- $10/sec Passive Income\n- x3 Triple Catch Mode!");
            }
        }

        function updateIndexProgress() {
            const count = gameState.discovered.size;
            const total = capyTypes.length;
            document.getElementById('index-progress').textContent = `${count}/${total}`;
        }

        function renderBaits() {
            const container = document.getElementById('bait-container');
            container.innerHTML = '';

            Object.values(baits).forEach(bait => {
                const isCurrent = gameState.currentBaitId === bait.id;
                const canAfford = gameState.money >= bait.cost;
                const stock = gameState.baitStock[bait.id];
                const isGrass = bait.id === 'grass';

                const btn = document.createElement('div');
                btn.className = `
                    flex-shrink-0 w-32 p-2 rounded-xl border-2 cursor-pointer transition-all
                    ${isCurrent ? 'border-teal-500 bg-teal-50 ring-2 ring-teal-200' : 'border-slate-200 bg-white hover:border-teal-300'}
                    ${!isGrass && stock === 0 && !canAfford ? 'opacity-60 grayscale' : ''}
                `;
                
                let actionText = '';
                let buttonColorClass = '';

                if (isGrass) {
                    actionText = isCurrent ? 'Equipped' : 'Equip';
                    buttonColorClass = isCurrent ? 'text-teal-600' : 'text-blue-500';
                } else {
                    if (isCurrent) {
                         // Active: Click to Buy More
                         actionText = `Buy 1 $${bait.cost}`;
                         buttonColorClass = canAfford ? 'text-green-600' : 'text-red-400';
                    } else {
                        if (stock > 0) {
                            actionText = `Equip x${stock}`;
                            buttonColorClass = 'text-blue-500';
                        } else {
                            actionText = `Buy 1 $${bait.cost}`;
                            buttonColorClass = canAfford ? 'text-green-600' : 'text-red-400';
                        }
                    }
                }

                btn.innerHTML = `
                    <div class="relative">
                        <div class="text-2xl text-center mb-1">${bait.icon}</div>
                        ${!isGrass ? `<div class="absolute -top-1 -right-1 bg-slate-700 text-white text-[10px] px-1.5 rounded-full">${stock}</div>` : ''}
                    </div>
                    <div class="font-bold text-sm text-center text-slate-700">${bait.name}</div>
                    <div class="text-xs text-center text-slate-500 mb-1">${bait.desc}</div>
                    <div class="text-xs font-bold text-center ${buttonColorClass}">
                        ${actionText}
                    </div>
                `;

                btn.onclick = (e) => {
                    e.stopPropagation();
                    
                    if (isGrass) {
                        if (!isCurrent) {
                            gameState.currentBaitId = 'grass';
                            renderBaits();
                        }
                        return;
                    }

                    // Logic for premium baits
                    if (isCurrent) {
                        // Already equipped? Buy more.
                        if (canAfford) {
                            gameState.money -= bait.cost;
                            gameState.baitStock[bait.id]++;
                            playSound('sell'); // reuse coin sound
                            updateMoneyDisplay();
                        }
                    } else {
                        // Not equipped
                        if (stock > 0) {
                            // Have stock? Equip it.
                            gameState.currentBaitId = bait.id;
                            renderBaits();
                        } else {
                            // No stock? Buy one.
                            if (canAfford) {
                                gameState.money -= bait.cost;
                                gameState.baitStock[bait.id]++;
                                playSound('sell'); // reuse coin sound
                                updateMoneyDisplay();
                                if (gameState.baitStock[bait.id] === 1) {
                                     gameState.currentBaitId = bait.id;
                                     renderBaits();
                                }
                            }
                        }
                    }
                };
                container.appendChild(btn);
            });

            // Update Luck Text
            const currentBait = baits[gameState.currentBaitId];
            let luckText = 'Normal';
            if (currentBait.luck > 1.5) luckText = 'High';
            if (currentBait.luck > 3) luckText = 'Legendary';
            document.getElementById('bait-bonus').textContent = `Luck: ${luckText}`;
        }

        // --- Auto Fish Logic ---

        function toggleAutoFish() {
            if (!gameState.hasAutoFish) return;
            
            const btn = document.getElementById('autofish-btn');
            
            if (gameState.isAutoFishing) {
                // STOP Auto Fish
                gameState.isAutoFishing = false;
                clearTimeout(gameState.autoFishTimeout);
                btn.classList.remove('bg-green-500', 'border-green-300', 'animate-pulse');
                btn.classList.add('bg-slate-700');
                
                // If we were waiting for a catch, stop it safely
                resetFishingState();
            } else {
                // START Auto Fish
                gameState.isAutoFishing = true;
                btn.classList.remove('bg-slate-700');
                btn.classList.add('bg-green-500', 'border-green-300', 'animate-pulse');
                
                // If manual fishing is happening, cancel it first
                if (gameState.isFishing) {
                    resetFishingState();
                    setTimeout(runAutoFishCycle, 500);
                } else {
                    runAutoFishCycle();
                }
            }
        }

        function runAutoFishCycle() {
            if (!gameState.isAutoFishing) return;

            // Consume Bait logic for Auto Fish
            if (!consumeBait()) {
                // If consumeBait returns false, it means we ran out and switched to grass (or were already on grass)
                // We continue fishing with grass.
                renderBaits(); 
            } else {
                renderBaits(); 
            }

            // Start Fishing Sequence
            gameState.isFishing = true;
            gameState.isCasting = true; // Lock manual interactions
            
            const msg = document.getElementById('game-message');
            const fisherman = document.getElementById('fisherman');
            
            msg.textContent = "Auto-Fishing...";
            msg.classList.add('animate-pulse');
            
            fisherman.classList.add('-rotate-12');
            playSound('cast');

            setTimeout(() => {
                fisherman.classList.remove('-rotate-12');
                gameState.isCasting = false;

                // Calculate Wait Time (Normal * 1.5)
                // Lure Reduction: Each level reduces base time by 15%
                const lureReduction = 1 - (gameState.lureLevel * 0.15);
                const baseWait = (2000 + Math.random() * 3000) * lureReduction;
                const autoWait = baseWait * 1.5;

                gameState.autoFishTimeout = setTimeout(() => {
                    if (gameState.isAutoFishing) {
                        autoCatch();
                    }
                }, autoWait);

            }, 300);
        }

        function autoCatch() {
            playSound('bite');
            // Small delay to simulate "catching"
            setTimeout(() => {
                if (!gameState.isAutoFishing) return;
                performFishing(true); // true = isAuto
            }, 500);
        }

        // --- Fishing Logic ---

        function consumeBait() {
            const currentId = gameState.currentBaitId;
            if (currentId === 'grass') return true;

            if (gameState.baitStock[currentId] > 0) {
                gameState.baitStock[currentId]--;
                return true;
            } else {
                // Out of stock! Switch to grass
                gameState.currentBaitId = 'grass';
                return false;
            }
        }

        function handlePondClick() {
            if (gameState.isOnCooldown) {
                // Cooldown feedback
                const msg = document.getElementById('game-message');
                msg.textContent = "Wait...";
                msg.classList.add('text-slate-400');
                setTimeout(() => msg.classList.remove('text-slate-400'), 200);
                return;
            }
            
            if (gameState.isAutoFishing) {
                const msg = document.getElementById('game-message');
                msg.textContent = "Auto-Fisher is Active!";
                setTimeout(() => { if(gameState.isAutoFishing) msg.textContent = "Auto-Fishing..."; }, 1000);
                return;
            }
            if (gameState.isCasting || gameState.showingCatch) return;

            const fisherman = document.getElementById('fisherman');
            const msg = document.getElementById('game-message');

            if (!gameState.isFishing) {
                // ATTEMPT TO CAST
                
                // Consume Bait logic
                const hasBait = consumeBait();
                renderBaits(); // Update UI
                
                if (!hasBait && gameState.currentBaitId === 'grass') {
                    // This happens if we tried to use premium, ran out, and swapped.
                }

                gameState.isFishing = true;
                gameState.isCasting = true;
                msg.textContent = "Waiting...";
                msg.classList.add('animate-pulse');
                
                fisherman.classList.add('-rotate-12');
                playSound('cast');
                
                setTimeout(() => {
                    fisherman.classList.remove('-rotate-12');
                    gameState.isCasting = false;
                    
                    // Lure Logic
                    const lureReduction = 1 - (gameState.lureLevel * 0.15);
                    const waitTime = (2000 + Math.random() * 3000) * lureReduction;
                    
                    gameState.biteTimeout = setTimeout(() => {
                        triggerBite();
                    }, waitTime);

                }, 300);

            } else if (gameState.isWaitingForBite) {
                reelIn();
            } else {
                cancelFishing("Too early!");
            }
        }

        function triggerBite() {
            if (!gameState.isFishing) return;

            gameState.isWaitingForBite = true;
            const msg = document.getElementById('game-message');
            
            msg.textContent = "‚ùó BITE! TAP NOW! ‚ùó";
            msg.classList.remove('animate-pulse');
            msg.classList.add('text-red-500', 'scale-110');
            playSound('bite');

            gameState.reactionTimeout = setTimeout(() => {
                if (gameState.isFishing) {
                    cancelFishing("Got away...");
                }
            }, 1000);
        }

        function reelIn() {
            clearTimeout(gameState.reactionTimeout);
            if (gameState.isWaitingForBite) {
                gameState.isWaitingForBite = false; 
                performFishing(false);
            } else {
                cancelFishing("???");
            }
        }

        // Handles catch loop (single vs triple)
        function performFishing(isAuto) {
             const catches = [];
             const count = gameState.tripleCatchMode ? 3 : 1;

             for(let i=0; i<count; i++) {
                 catches.push(getSingleCatchResult());
             }

             // Sort catches by rarity/value to show the best one mainly
             catches.sort((a, b) => b.value - a.value);

             showCatch(catches, isAuto);
        }

        function getSingleCatchResult() {
            const bait = baits[gameState.currentBaitId];
            const luck = bait.luck;
            
            let pool = [];
            capyTypes.forEach(capy => {
                if (luck >= capy.minLuck) {
                    let weight;
                    if (capy.value <= 15) {
                        weight = capy.rarity / luck; 
                    } else {
                        weight = capy.rarity * luck;
                    }
                    pool.push({ ...capy, weight: weight });
                }
            });

            const totalWeight = pool.reduce((sum, item) => sum + item.weight, 0);
            let random = Math.random() * totalWeight;
            let caught = pool[0]; 

            for (let item of pool) {
                if (random < item.weight) {
                    caught = item;
                    break;
                }
                random -= item.weight;
            }
            return caught;
        }

        function showCatch(catches, isAuto) {
            // Add all to inventory
            catches.forEach(c => gameState.inventory.push(c));
            
            gameState.showingCatch = true;
            updateBagCount();
            playSound('catch');
            
            // Check Discovery
            let newDiscoveryFound = false;
            catches.forEach(c => {
                if (!gameState.discovered.has(c.id)) {
                    gameState.discovered.add(c.id);
                    newDiscoveryFound = true;
                }
            });
            if (newDiscoveryFound) {
                updateIndexProgress();
                checkIndexCompletion();
            }
            
            const feedback = document.getElementById('catch-feedback');
            const img = document.getElementById('caught-emoji');
            const name = document.getElementById('caught-name');
            const val = document.getElementById('caught-value');
            const newLabel = document.getElementById('new-discovery');
            const msg = document.getElementById('game-message');
            
            // Show the "Best" catch visually
            const bestCatch = catches[0];
            
            img.innerHTML = bestCatch.icon;
            
            if (catches.length > 1) {
                // Triple Mode Display
                name.textContent = `${bestCatch.name} + ${catches.length - 1} others!`;
                const totalVal = catches.reduce((sum, c) => sum + c.value, 0);
                val.textContent = `+$${totalVal}`;
                if(!isAuto) msg.textContent = "Triple Catch!";
            } else {
                // Standard Display
                name.textContent = bestCatch.name;
                val.textContent = `+$${bestCatch.value}`;
                if(!isAuto) msg.textContent = "Gotcha!";
            }
            
            if (isAuto && catches.length === 1) {
                 msg.textContent = `Caught ${bestCatch.name}!`;
            }

            if (newDiscoveryFound) newLabel.classList.remove('hidden');
            else newLabel.classList.add('hidden');
            
            feedback.classList.remove('hidden');

            // For auto-fishing, shorter celebration
            const celebrationTime = isAuto ? 1000 : 2000;

            setTimeout(() => {
                feedback.classList.add('hidden');
                gameState.showingCatch = false;
                
                if (gameState.isAutoFishing) {
                    runAutoFishCycle(); // Loop
                } else {
                    resetFishingState();
                }
            }, celebrationTime);
        }

        function cancelFishing(reason) {
            const msg = document.getElementById('game-message');
            msg.textContent = reason;
            msg.classList.remove('text-red-500', 'scale-110');
            playSound('fail');
            
            // ACTIVATE COOLDOWN
            gameState.isOnCooldown = true;

            setTimeout(() => {
                if (gameState.isAutoFishing) {
                     gameState.isOnCooldown = false;
                     runAutoFishCycle(); 
                } else {
                     resetFishingState();
                     setTimeout(() => {
                        gameState.isOnCooldown = false;
                     }, 2000);
                }
            }, 1000);
        }

        function resetFishingState() {
            gameState.isFishing = false;
            gameState.isWaitingForBite = false;
            clearTimeout(gameState.biteTimeout);
            clearTimeout(gameState.reactionTimeout);
            
            const msg = document.getElementById('game-message');
            // If we are in the "Post-Fail Cooldown", show a different message
            if (gameState.isOnCooldown && !gameState.isAutoFishing) {
                 msg.textContent = "Wait...";
                 msg.classList.add('text-slate-400');
                 
                 // Update message when cooldown expires
                 setTimeout(() => {
                     if (!gameState.isFishing) {
                        msg.textContent = "Tap to Cast!";
                        msg.classList.remove('text-slate-400', 'animate-pulse', 'text-red-500', 'scale-110');
                     }
                 }, 2000); 
            } else {
                msg.textContent = "Tap to Cast!";
                msg.classList.remove('animate-pulse', 'text-red-500', 'scale-110');
            }
        }

        // --- Shop, Inventory, Index & Upgrades Logic ---

        function openInventory() {
            document.getElementById('inventory-modal').classList.remove('hidden');
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';

            if (gameState.inventory.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-400 mt-10 italic">Your bag is empty. Go fish!</div>';
            } else {
                gameState.inventory.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between bg-slate-50 p-2 rounded-lg border border-slate-100';
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12">${item.icon}</div>
                            <span class="font-bold text-slate-700">${item.name}</span>
                        </div>
                        <span class="font-mono text-green-600 font-bold">$${item.value}</span>
                    `;
                    list.appendChild(el);
                });
            }
            updateSellButton();
        }

        function closeInventory() { document.getElementById('inventory-modal').classList.add('hidden'); }
        function openIndex() { 
            document.getElementById('index-modal').classList.remove('hidden');
            const grid = document.getElementById('index-grid');
            grid.innerHTML = '';
            capyTypes.forEach(capy => {
                const isDiscovered = gameState.discovered.has(capy.id);
                const el = document.createElement('div');
                el.className = `flex flex-col items-center justify-center p-2 rounded-xl border-2 aspect-square
                    ${isDiscovered ? 'bg-white border-teal-200 shadow-sm' : 'bg-slate-100 border-slate-200'}`;
                
                if (isDiscovered) {
                    el.innerHTML = `<div class="w-12 h-12 mb-1">${capy.icon}</div><div class="text-[10px] font-bold text-center leading-tight">${capy.name}</div>`;
                } else {
                    el.innerHTML = `<div class="text-3xl text-slate-300 opacity-50">?</div><div class="text-[10px] font-bold text-slate-300 text-center mt-1">LOCKED</div>`;
                }
                grid.appendChild(el);
            });
        }
        function closeIndex() { document.getElementById('index-modal').classList.add('hidden'); }

        // Upgrades Modal Logic
        function openUpgrades() {
            document.getElementById('upgrades-modal').classList.remove('hidden');
            renderUpgrades();
        }
        
        function closeUpgrades() { document.getElementById('upgrades-modal').classList.add('hidden'); }

        function renderUpgrades() {
            const list = document.getElementById('upgrades-list');
            list.innerHTML = '';

            // Render Lure
            const lureCost = upgradeData.lure.costs[gameState.lureLevel];
            const lureMaxed = gameState.lureLevel >= upgradeData.lure.max;
            
            list.appendChild(createUpgradeItem(
                upgradeData.lure.name, 
                `Level ${gameState.lureLevel}/${upgradeData.lure.max}`,
                upgradeData.lure.desc,
                lureMaxed ? "Maxed" : `$${lureCost}`,
                lureMaxed ? false : (gameState.money >= lureCost),
                () => buyLure(lureCost)
            ));

            // Render Sell
            const sellCost = upgradeData.sell.costs[gameState.sellMultiplierLevel];
            const sellMaxed = gameState.sellMultiplierLevel >= upgradeData.sell.max;

            list.appendChild(createUpgradeItem(
                upgradeData.sell.name, 
                `Level ${gameState.sellMultiplierLevel}/${upgradeData.sell.max}`,
                upgradeData.sell.desc,
                sellMaxed ? "Maxed" : `$${sellCost}`,
                sellMaxed ? false : (gameState.money >= sellCost),
                () => buySellUpgrade(sellCost)
            ));

            // Render Auto-Fish
            const autoBought = gameState.hasAutoFish;
            list.appendChild(createUpgradeItem(
                upgradeData.auto.name, 
                autoBought ? "Owned" : "One-Time Purchase",
                upgradeData.auto.desc,
                autoBought ? "Owned" : `$${upgradeData.auto.costs[0]}`,
                autoBought ? false : (gameState.money >= upgradeData.auto.costs[0]),
                () => buyAutoFish(upgradeData.auto.costs[0])
            ));
        }

        function createUpgradeItem(title, sub, desc, btnText, canAfford, onClick) {
            const el = document.createElement('div');
            el.className = 'bg-slate-50 p-4 rounded-2xl border border-slate-200 flex flex-col gap-2';
            el.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-bold text-slate-800 text-lg">${title}</div>
                        <div class="text-xs font-bold text-slate-500 uppercase">${sub}</div>
                        <div class="text-xs text-slate-600 mt-1">${desc}</div>
                    </div>
                </div>
                <button class="mt-2 w-full py-2 rounded-lg font-bold transition-transform active:scale-95 ${canAfford ? 'bg-purple-500 hover:bg-purple-600 text-white shadow-md' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}">
                    ${btnText}
                </button>
            `;
            if (canAfford) {
                el.querySelector('button').onclick = onClick;
            }
            return el;
        }

        function buyLure(cost) {
            if (gameState.money >= cost) {
                gameState.money -= cost;
                gameState.lureLevel++;
                playSound('sell');
                updateMoneyDisplay();
            }
        }

        function buySellUpgrade(cost) {
            if (gameState.money >= cost) {
                gameState.money -= cost;
                gameState.sellMultiplierLevel++;
                playSound('sell');
                updateMoneyDisplay();
            }
        }

        function buyAutoFish(cost) {
            if (gameState.money >= cost) {
                gameState.money -= cost;
                gameState.hasAutoFish = true;
                playSound('sell');
                updateMoneyDisplay();
                document.getElementById('autofish-btn').classList.remove('hidden');
                alert("Auto-Fisher 3000 Unlocked!\nCheck the header for the Robot Button.");
            }
        }

        // --- Admin Functions ---
        function openAdmin() { document.getElementById('admin-modal').classList.remove('hidden'); }
        function closeAdmin() { document.getElementById('admin-modal').classList.add('hidden'); }
        
        function adminAddMoney(amount) {
            gameState.money += amount;
            updateMoneyDisplay();
            playSound('sell');
        }

        function adminUnlockAll() {
            capyTypes.forEach(c => gameState.discovered.add(c.id));
            updateIndexProgress();
            checkIndexCompletion();
            alert("Unlocked all Capybaras!");
            closeAdmin();
        }

        function resetGame() {
            if(confirm("Are you sure? This deletes everything.")) {
                location.reload();
            }
        }

        function sellAll() {
            if (gameState.inventory.length === 0) return;

            let totalValue = gameState.inventory.reduce((sum, item) => sum + item.value, 0);
            
            // Apply Sell Multiplier
            const multiplier = 1 + (gameState.sellMultiplierLevel * 0.2); // +20% per level
            totalValue = Math.floor(totalValue * multiplier);

            gameState.money += totalValue;
            gameState.inventory = []; 
            
            playSound('sell');
            updateMoneyDisplay();
            updateBagCount();
            
            const msg = document.getElementById('game-message');
            msg.textContent = `Sold for $${totalValue}!`;
            setTimeout(() => {
                if (!gameState.isFishing && !gameState.isAutoFishing) msg.textContent = "Tap to Cast!";
            }, 2000);
        }

        function updateSellButton(val) {
             let baseVal = gameState.inventory.reduce((sum, item) => sum + item.value, 0);
             const multiplier = 1 + (gameState.sellMultiplierLevel * 0.2);
             const totalVal = Math.floor(baseVal * multiplier);
             document.getElementById('total-sell-value').textContent = `$${totalVal}`;
        }

        // Start
        init();
        updateIndexProgress();

    </script>
</body>
</html>
